<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta content='width=device-width' name='viewport'>
    <meta name="theme-color" content="#222222">
    <title>Install WLED</title>
    <script type="module" src="js/install-button-320.js"></script>
    <script>
    </script>
    <style>
        body {
            font-family: Verdana, Helvetica, sans-serif;
            text-align: center;
            background-color: #222;
            margin: 0;
            color: #fff;
        }
        
        .sub {
            margin: -18px 0 18px 0;
            color: #09f;
        }
        
        .btn {
            outline: none;
            cursor: pointer;
            padding: 8px;
            margin: 10px;
            width: 230px;
            font-family: Verdana, Helvetica, sans-serif;
            font-size: 19px;
            background-color: #333;
            color: white;
            border: 0px solid white;
            border-radius: 25px;
        }
        
        img {
            width: 770px;
            max-width: 80%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            margin: 3vh 0 5px 0;
            animation: fi 1s;
        }
        
        @keyframes fi {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .main {
            animation: fi 1.5s .7s both;
        }
        
        a {
            color: #fff;
            cursor: pointer;
            text-decoration: underline;
        }
        
        ol {
            margin: auto;
            text-align: left;
            display: inline-block;
        }
        
        li::marker {
            text-decoration: bold;
            color: #09f;
        }
        
        li {
            margin: 5px;
        }
        
        .clickable {
            cursor: pointer;
        }
        
        .container {
            width: 80%;
            max-width: 510px;
            margin: auto;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #222;
            overflow: hidden;
        }
        
        .inst-button {
            padding: 5px 0;
        }
        
        .log {
            padding: 6px 20px 8px 20px;
            display: none;
        }
        
        #reset-button {
            display: none;
        }
        
        .info-top {
            font-size: 32px;
            display: inline-block;
        }
        
        .info-bot {
            display: inline-block;
        }
        
        #state {
            float: left;
        }
        
        #progress {
            float: right;
        }
        
        #bar {
            height: 12px;
            width: 100%;
            margin: 26px 0 8px 0;
            border-radius: 25px;
            background: linear-gradient(to right, red, orange, yellow, #0a0, cyan, #09f);
            overflow: hidden;
            position: relative;
        }
        
        #bar-inner {
            transform: translate(-50%, -10%);
            width: 200%;
            height: 120%;
            background: linear-gradient(to right, #fff 50%, #444 50%);
            transition: transform 3s;
            position: absolute;
            left: 0;
            top: 0;
        }
        
        #env {
            float: left;
        }
        
        #extra {
            float: right;
        }
    </style>
</head>

<body onload="checkSupported()">
    <div class="main">
        <h2>Welcome to the openHASP web installer!</h2>

        <div id="flasher">

            <ol>
                <li>Plug in your ESP to a USB port. We will install WLED 0.12.0 to it.</li>
                <li id="coms">Hit "Install" and select the correct COM port. <a onclick="showSerialHelp()">No device found?</a>
                </li>
                <li>Wait a while, the process is a lot faster if you stay on this tab.</li>
            </ol><br><br>

            <div class="container inst-button">
                <esp-web-install-button id="inst" manifest="https://td-er.nl/ESPEasy/static/esp32/ESP_Easy_mega_20210615_display_ESP32_4M316k-factory.manifest.json" hide-progress erase-first>
                    <button class="btn" slot="activate">Install</button>
                </esp-web-install-button><br>
                <input type="checkbox" id="erase" name="erase" onchange="toggleErase()" checked>
                <label for="erase"> Clean install (deletes presets and settings)</label><br>
            </div>

            <div class="container log">
                <span class="info-top" id="state">Initializing...</span>
                <span class="info-top" id="progress"></span><br>
                <div id="bar">
                    <div id="bar-inner"></div>
                </div>
                <span class="info-bot" id="env">&nbsp;</span>
                <span class="info-bot" id="extra">&nbsp;</span>
            </div>
            <div id="reset-button">
                <br><button class="btn" onclick="reset()">&#8635; Start over</button><br>
            </div>

        </div>
        <br>Powered by <a href="https://esphome.github.io/esp-web-tools/" target="_blank">ESP Web Tools</a>

        <script>
            function handleStateEvent(ev) {
                var obj = ev.detail;
                //console.log(obj);
                var s = obj.state;
                if (s == "writing") {
                    //progress
                    var i = obj.details.percentage;
                    document.getElementById('state').textContent = "Writing...";
                    document.getElementById('progress').textContent = i + "%";
                    document.getElementById('extra').textContent = `${(obj.details.bytesWritten / 1000).toFixed(1)} / ${(obj.details.bytesTotal / 1000).toFixed(1)} kB`
                        //bar
                    var a = (i < 50) ? 1.0 : 1.0 - (i - 50) * 0.02;
                    document.getElementById('bar-inner').style.transform = `translate(-${(100 - i) / 2}%,-10%)`
                    document.getElementById('bar-inner').style.background = `linear-gradient(to right, rgba(255,255,255,${a}) 50%, #444 50%)`;
                } else {
                    document.getElementById('state').textContent = obj.message;

                    //env
                    var manifestName = obj.manifest ? obj.manifest.name : "";
                    var chipFamily = obj.chipFamily;
                    var env = "";
                    if (manifestName) {
                        env = obj.manifest.name;
                        if (chipFamily) env += " - "
                    }
                    if (chipFamily) env += obj.chipFamily;
                    if (env == "") env = "&nbsp;";
                    document.getElementById('env').innerHTML = env;

                    //hide button and show log
                    if (s == "initializing") {
                        document.getElementsByClassName('inst-button')[0].style.display = "none";
                        document.getElementsByClassName('log')[0].style.display = "block";
                    } else if (s == "finished") {
                        document.getElementById('reset-button').style.display = "block";
                    } else if (s == "error") {
                        document.getElementById('state').textContent = "Error!";
                        document.getElementById('extra').textContent = obj.message;
                        document.getElementById('reset-button').style.display = "block";
                        if (!obj.chipFamily) document.getElementById('env').textContent = "";
                    }
                }
            }



            function toggleErase() {
                if (document.getElementById('erase').checked) {
                    document.getElementById('inst').setAttribute('erase-first', '');
                } else {
                    document.getElementById('inst').removeAttribute('erase-first');
                }
            }

            function reset() {
                document.getElementById('bar-inner').style.transform = `translate(-50%,-10%)`
                document.getElementById('bar-inner').style.background = `linear-gradient(to right, rgba(255,255,255,1.0) 50%, #444 50%)`;
                document.getElementById('progress').textContent = "";
                document.getElementById('extra').textContent = "";
                document.getElementsByClassName('inst-button')[0].style.display = "block";
                document.getElementsByClassName('log')[0].style.display = "none";
                document.getElementById('reset-button').style.display = "none";
            }

            function checkSupported() {
                if (document.getElementById('inst').hasAttribute('install-unsupported')) unsupported();
            }



            function unsupported() {
                document.getElementById('flasher').innerHTML = "Sorry, your browser is not yet supported!<br>Please try on Desktop Chrome or Edge.<br>"
            }

            function showSerialHelp() {
                document.getElementById('coms').innerHTML = `Hit "Install" and select the correct COM port.<br><br>
      You might be missing the drivers for your board.<br>
      Here are drivers for chips commonly used in ESP boards:<br>
      <a href="https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers" target="_blank">CP2102 (square chip)</a><br>
      <a href="https://github.com/nodemcu/nodemcu-devkit/tree/master/Drivers" target="_blank">CH34x (rectangular chip)</a><br><br>
      Make sure your USB cable supports data transfer.<br><br>
      `;
            }

            const espWebInstallButton = document.querySelector("esp-web-install-button");
            espWebInstallButton.addEventListener("state-changed", handleStateEvent);
        </script>

</body>

</html>